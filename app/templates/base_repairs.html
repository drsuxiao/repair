{%extends "base.html"%}
<!-- 主体内容 -->
{% block title %}设备维修管理{% endblock %}

{% block content %}
<!-- 搜素面板 -->
<div class="panel panel-default">
    <a data-toggle="collapse" data-parent="#accordion"  href="#pn_query">
        显示/隐藏查询框<span class="caret"></span>  <!-- 下拉符号 -->
    </a>
    <div id="pn_query" class="panel-collapse collapse in table-responsive">
        <table class="table table-condensed">
            <tr>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_date" >报修日期</label></td>
                <td style=" white-space:nowrap">
                    <table><tr>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="repair_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="repair_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_dept_code">报修科室</label></td>
                <td style=" white-space:nowrap"><select class="selectpicker form-control input-sm"  id="dept_code" title="请选择">
                </select></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_brand_code">设备品牌</label></td>
                <td style=" white-space:nowrap"><select class="selectpicker form-control input-sm" id="brand_code" title="请选择"></select></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_return_man">维修归还人</label></td>
                <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 200px" type="text" id="repair_return_man"></td>
            </tr>  <!--  -->
            <tr>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_equipment_confirm_date">报修确认日期</label></td>
                <td style=" white-space:nowrap">
                    <table><tr>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="equipment_confirm_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="equipment_confirm_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_registrant">报修人</label></td>
                <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 200px" type="text" id="repair_registrant"></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_type_code">设备类型</label></td>
                <td style=" white-space:nowrap"><select class="selectpicker form-control input-sm" id="type_code" title="请选择"></select></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_equipment_return_man">归还科室人</label></td>
                <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 200px" type="text" id="equipment_return_man"></td>
            </tr>
            <tr>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_return_date">维修归还日期</label></td>
                <td style=" white-space:nowrap">
                    <table><tr>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="repair_return_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="repair_return_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_com_code">维修公司</label></td>
                <td style=" white-space:nowrap"><select class="selectpicker form-control input-sm" id="com_code" title="请选择"></select></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_equipment_code">设备编码</label></td>
                <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 200px" id="equipment_code"></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_status">维修进度</label></td>
                <td style=" white-space:nowrap">
                    <select class="selectpicker form-control input-sm" id="repair_status" title="请选择">
                        <option></option>
                        <option value="0">未确认</option>
                        <option value="1">已确认</option>
                        <option value="2">已完成</option>
                    </select></td>
            </tr>
            <tr>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_equipment_return_date">归还科室日期</label></td>
                <td style=" white-space:nowrap">
                    <table><tr>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="equipment_return_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 120px" type="text" id="equipment_return_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_repair_man">维修人</label></td>
                <td style=" white-space:nowrap"><input class="form-control input-sm" style="width: 200px" type="text" id="repair_man"></td>
                <td style=" white-space:nowrap"><label><input type="checkbox" id="cb_fault_code">设备故障</label></td>
                <td style=" white-space:nowrap"><select class="selectpicker form-control input-sm" id="fault_code" title="请选择"></select></td>
                <td style=" white-space:nowrap"></td>
                <td style=" white-space:nowrap">
                    <button class="btn btn-primary btn-sm" id="query">查询</button>
                    <button class="btn btn-primary btn-sm" id="reset">重置</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<!-- 数据表 -->
<div class=table-responsive">   <!-- 自适应列宽，高度  -->
    <table id="table_repairs" class="table text-nowrap"></table>
</div>
<!-- 工具容器 -->
<div id="toolbar">{% block function %}{% endblock %}</div>
{% endblock %}

{% block script %}
$(function(){
    $('.selectpicker').selectpicker({
        liveSearch:true,
        container: "body",
        liveSearch: true,
        width: 200,
        size: 5
    });

    var select_list = [
        {"id":"dept_code", "url":"/repair/api/v1.0/departments", "valuefield":"dept_code", "textfield":"dept_name"},
        {"id":"brand_code", "url":"/repair/api/v1.0/equipment_brands", "valuefield":"brand_code", "textfield":"brand_name"},
        {"id":"type_code", "url":"/repair/api/v1.0/equipment_types", "valuefield":"type_code", "textfield":"type_name"},
        {"id":"fault_code", "url":"/repair/api/v1.0/equipment_faults", "valuefield":"fault_code", "textfield":"fault_name"},
        {"id":"com_code", "url":"/repair/api/v1.0/repair_companys", "valuefield":"com_code", "textfield":"com_name"}
    ];
    //$(id_list).each(function(){ 使用此方式就是获取不到ID的值？？？？
    $.each(select_list, function (i, item) {
        $.get(this.url,function(data,status){
            init($("#"+item['id']), data.rows, item['valuefield'],item['textfield']);
          });
    });

    var id_list = [
        {"start":"repair_date", "end":"repair_date_end"},
        {"start":"equipment_confirm_date", "end":"equipment_confirm_date_end"},
        {"start":"repair_return_date", "end":"repair_return_date_end"},
        {"start":"equipment_return_date", "end":"equipment_return_date_end"}
    ];

    $(id_list).each(function(){
        $("#" + this.start).datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            weekStart: 0,
            //startDate:new Date(),
            autoclose: true,
            startView: 2,  	//打开时显示的视图。0-'hour' 1-'day' 2-'month' 3-'year' 4-'decade'
            todayBtn : true,
            todayHighlight: true,
            bootcssVer:3,	//显示向左向右的箭头
            forceParse: true,  	//当输入非格式化日期时，强制格式化。默认true
            initialDate: new Date(),	//初始化日期.默认new Date()当前日期
            showMeridian: true, //是否显示上下午
            keyboardNavigation: true, //方向键改变日期
            language: 'zh-CN' //语言
        }).on("click",function(){
        $("#" + this.start).datetimepicker("setEndDate",$("#" + this.end).val())});

        $("#" + this.end).datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            weekStart: 0,
            //startDate:new Date(),
            autoclose: true,
            startView: 2,  	//打开时显示的视图。0-'hour' 1-'day' 2-'month' 3-'year' 4-'decade'
            todayBtn : true,
            todayHighlight: true,
            bootcssVer:3,	//显示向左向右的箭头
            forceParse: true,  	//当输入非格式化日期时，强制格式化。默认true
            initialDate: new Date(),	//初始化日期.默认new Date()当前日期
            showMeridian: true, //是否显示上下午
            keyboardNavigation: true, //方向键改变日期
            language: 'zh-CN' //语言
        }).on("click",function(){
        $("#" + this.end).datetimepicker("setStartDate",$("#" + this.start).val())});
    });
});

function init(target, data, valuefield, textfield) {
            var option = $('<option></option>');
            target.append(option);
           $.each(data, function (i, item) {
               var option = $('<option></option>');
               option.attr('value', item[valuefield]);
               option.text(item[textfield]);
               target.append(option);
           });
    target.selectpicker('refresh');
    target.selectpicker('render');
};
var querystr = {};
$("#query").click(function(){
    var temp = {};
    $.each($('input:checkbox:checked'),function(){
        input_id = $(this).attr('id').substr(3);

        list = new Array();
        if(input_id.indexOf("_date") >= 0 ) {
            list.push($("#"+input_id).val());
            list.push($("#"+input_id+"_end").val());
            value = list;
        }
        else{
            value = $("#"+input_id).val();
        }
        temp[input_id] = value;
        //alert("你选了："+$('input[type=checkbox]:checked').length+"个，其中有："+input_id+":"+value);
    });
    alert(JSON.stringify(temp));  //可以将json对象转换成字符串;
    querystr = temp;
    if (JSON.stringify(querystr) != "{}"){$("#table_repairs").bootstrapTable("refresh");}
    else{$("#table_repairs").bootstrapTable("refresh");}

});

$("#reset").click(function(){
    $("input[type='checkbox']").each(function(){
        this.checked = false;
    });
    //$("input[type='checkbox']").checked = true;
    //$("input[type='text']").attr("value", '-');
    //$(".selectpicker").selectpicker('val','002');
    //$('.selectpicker').selectpicker('refresh');  
    //$('.selectpicker').selectpicker('render'); 
});

//转换日期格式(时间戳转换为datetime格式)
function changeDateFormat(value) {
    if (value != null) {
        var date = new Date(value);
        return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes();
    }
};


//表格初始化
initTable();
//表格初始化
function initTable() {
//先销毁表格
$("#table_repairs").bootstrapTable({
//表格高度
//height: getHeight()-300,
//服务器数据的请求方式 'get' 或 'post'。
method: 'get',
//设置为 true 会有隔行变色效果
striped: true,
//设置为 true 会在表格底部显示分页条。
pagination: true,
//请求后台的URL
url: '/repair/api/v1.0/equipment_repairs',
//服务器返回的数据类型。
dataType: 'json',
//工具按钮用哪个容器
//toolbar: '#toolbar',
//是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性
cache: false,
//设置为 true 启用分页条无限循环的功能
paginationLoop: false,
//设置在哪里进行分页，可选值为 'client' 或者 'server'。设置 'server'时，必须设置服务器数据地址（url）或者重写ajax方法
sidePagination: 'server',
//初始化加载第一页，默认第一页
pageNumber: 1,
//每页的记录行数
pageSize: 1,
//可供选择的每页的行数
pageList: [10,15,20, 50, 100],
//设置为false 将禁止所有列的排序。
sortable: true,
//设置默认排序为 name
sortName: 'id',
//定义排序方式，'asc' 或者 'desc'。
sortOrder: "desc",
//是否显示刷新按钮
showRefresh: false,
//是否显示内容列下拉框。
showColumns: false,
//显示导出插件
showExport: false,
exportDataType: "basic",
//是否显示右上角的搜索框
search: false,
//是否显示切换视图（table/card）按钮。
//showToggle:false,
//是否启用点击选中行
clickToSelect: false,
uniqueId: "id",                     //每一行的唯一标识，一般为主键列
showToggle: false,                   //是否显示详细视图和列表视图的切换按钮
cardView: false,                    //是否显示详细视图
detailView: false,                  //是否显示父子表
//设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
//设置为limit可以获取limit, offset, search, sort, order
queryParamsType:'limit',
searchOnEnterKey: false,
//请求服务器数据
queryParams: function queryParams(params){
var param = {
limit: params.limit,
offset: params.offset,
search: params.search,
querystr: JSON.stringify(querystr),
sort: params.sort,
order: params.order
};
return param;
},
//加载成功时执行
onLoadSuccess: function(data){
console.log("加载成功");
},
//加载失败时执行
onLoadError: function(status){
console.log("加载数据失败"+status);
},
onDblClickRow: function (row, $element) {
var id = row.id;
EditViewById(id);
return false;
},
onCheck: function(row,$element){
index = $element.data('index');
},
columns: [
{
title: "全选",
field: "select",
checkbox: true,
width: 20,//宽度
//align: "center",//水平
//valign: "middle",
formatter: function (value, row, index) {
return row._id;
}
},{
field: 'id',
title: '维修单号',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_date',
title: '报修日期',
align: 'left',
valign: 'middle',
sortable: true,
formatter: function (value, row, index) {
    return changeDateFormat(value)
}
},{
field: 'repair_department',
title: '报修科室',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_registrant',
title: '报修人',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_brand',
title: '设备品牌',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_type',
title: '设备类型',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_code',
title: '设备编号',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_fault',
title: '设备故障',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_brand',
title: '设备品牌',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_company',
title: '维修公司',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_man',
title: '维修人',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_confirm_date',
title: '维修确认日期',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_brand',
title: '设备品牌',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_return_date',
title: '维修归还日期',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_return_man',
title: '维修归还人',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_return_date',
title: '归还科室日期',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'equipment_return_man',
title: '归还科室人',
align: 'left',
valign: 'middle',
sortable: true
},{
field: 'repair_status',
title: '维修进度',
align: 'left',
valign: 'middle',
sortable: true,
formatter: function (value, row, index) {
    if (value == 0 ){
        value = '未确认'}
    else if(value == 1){
        value = '已确认'}
    else if(value == 2){
        value = '已完成'}
    return value
}
}]
});
};

//获取table的高度
function getHeight() {
return $(window).height() - 100;
};
//操作栏的格式化
function actionFormatter(value, row, index) {
var id = row.id;
var result = "";
result += "<a href='#' id='row_edit' class='btn btn-xs blue' onclick=\"EditViewById('" + String(id) + "')\" title='编辑'><span class='glyphicon glyphicon-pencil'></span></a>";
result += "<a href='#' id='row_remove' class='btn btn-xs red' onclick=\"DeleteById('" + String(id) + "')\" title='删除'><span class='glyphicon glyphicon-remove'></span></a>";
return result;
};
{% endblock %}
