{%extends "base.html"%}
<!-- 主体内容 -->
{% block title %}设备维修管理{% endblock %}

{% block content %}
<!-- 搜素面板 -->
<div class="panel panel-default">
    <a data-toggle="collapse" data-parent="#accordion"  href="#pn_query">
        显示/隐藏查询框<span class="caret"></span>  <!-- 下拉符号 -->
    </a>
    <div id="pn_query" class="panel-collapse collapse table-responsive">
        <table class="table table-condensed">
            <tr>
                <td style=" white-space:nowrap; border:0px;"><label class="control-label"><input type="checkbox" id="cb_query_repair_date" >报修日期</label></td>
                <td style=" white-space:nowrap; border:0px;">
                    <table><tr>
                        <td style=" white-space:nowrap;border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_repair_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap;border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_repair_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_dept_code">报修科室</label></td>
                <td style=" white-space:nowrap; border:0px;"><select class="selectpicker form-control input-sm"  id="query_dept_code" title="请选择">
                </select></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_brand_code">设备品牌</label></td>
                <td style=" white-space:nowrap; border:0px;"><select class="selectpicker form-control input-sm" id="query_brand_code" title="请选择"></select></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_repair_return_man">维修归还人</label></td>
                <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 200px" type="text" id="query_repair_return_man"></td>
            </tr>  <!--  -->
            <tr>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_equipment_confirm_date">报修确认日期</label></td>
                <td style=" white-space:nowrap; border:0px;">
                    <table><tr>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_equipment_confirm_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_equipment_confirm_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_repair_registrant">报修人</label></td>
                <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 200px" type="text" id="query_repair_registrant"></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_type_code">设备类型</label></td>
                <td style=" white-space:nowrap; border:0px;"><select class="selectpicker form-control input-sm" id="query_type_code" title="请选择"></select></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_equipment_return_man">归还科室人</label></td>
                <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 200px" type="text" id="query_equipment_return_man"></td>
            </tr>
            <tr>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_repair_return_date">维修归还日期</label></td>
                <td style=" white-space:nowrap; border:0px;">
                    <table><tr>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_repair_return_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_repair_return_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_com_code">维修公司</label></td>
                <td style=" white-space:nowrap; border:0px;"><select class="selectpicker form-control input-sm" id="query_com_code" title="请选择"></select></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_equipment_code">设备编码</label></td>
                <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" type="text" style="width: 200px" id="query_equipment_code"></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_repair_status">维修进度</label></td>
                <td style=" white-space:nowrap; border:0px;">
                    <select class="selectpicker form-control input-sm" id="query_repair_status" title="请选择">
                        <option></option>
                        <option value="0">未确认</option>
                        <option value="1">已确认</option>
                        <option value="2">维修中</option>
                        <option value="3">已完成</option>
                    </select></td>
            </tr>
            <tr>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_equipment_return_date">归还科室日期</label></td>
                <td style=" white-space:nowrap; border:0px;">
                    <table><tr>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_equipment_return_date" placeholder="开始日期"></td>
                        <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 120px" type="text" id="query_equipment_return_date_end" placeholder="结束日期"></td>
                    </tr></table>
                </td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_repair_man">维修人</label></td>
                <td style=" white-space:nowrap; border:0px;"><input class="form-control input-sm" style="width: 200px" type="text" id="query_repair_man"></td>
                <td style=" white-space:nowrap; border:0px;"><label><input type="checkbox" id="cb_query_fault_code">设备故障</label></td>
                <td style=" white-space:nowrap; border:0px;"><select class="selectpicker form-control input-sm" id="query_fault_code" title="请选择"></select></td>
                <td style=" white-space:nowrap; border:0px;"></td>
                <td style=" white-space:nowrap; border:0px;">
                    <button class="btn btn-primary btn-sm" id="query_search">查询</button>
                    <button class="btn btn-primary btn-sm" id="query_reset">重置</button>
                </td>
            </tr>
        </table>
        <div style="display: none;"><input type="text" id="query_list"></div>
    </div>
</div>
<!-- 数据表 -->
<div class=table-responsive">   <!-- 自适应列宽，高度  -->
    <table id="table_repairs" class="table table-bordered table-striped table-condensed text-nowrap"></table>
</div>
<!-- 工具容器 -->
<div id="toolbar">{% block function %}{% endblock %}</div>
{% block modal %}
<!-- 删除确认窗 -->
<div class="modal fade" id="modal_delete" tabindex="-1" role="dialog" aria-labelledby="modal_delete_label" aria-hidden="true"
data-backdrop="false" data-keyboard="false">
    <div class="modal-dialog" style="width: 300px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modal_delete_label">{{ delete_title }}</h4>
            </div>
            <div class="modal-body">
                <p>{{ delete_info }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success btn-sm" id="delete_confirm">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- 模态框 新增、编辑窗 -->
<div class="modal fade" id="{{ modal_id }}" tabindex="-1" role="dialog" aria-labelledby="modal_registration_label" aria-hidden="true"
                data-backdrop="false" data-keyboard="false">
    <div class="modal-dialog" style="width: 400px">
        <form class="form-horizontal" role="form"  id="{{ modal_id }}" method="post"  onsubmit="return false">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modal_registration_label">{{ modal_title }}</h4>
            </div>
            <div class="modal-body">
                    {{ form.hidden_tag() }}
                    {% for field in form if field.widget.input_type !='hidden' %}
                    <div class="form-group">
                        <label for="{{ field.widget.id }}" class="col-md-4 col-xs-4 control-label">{{ field.label }}</label>
                        <div class="col-md-7 col-xs-6">{{ field|safe }}</div>
                        <div class="col-md-1 col-xs-2">
                            {% if field.errors %}
                                <ul class=errors>
                                {% for error in field.errors %}
                                  <li>{{ error }}</li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary btn-sm" id="modal_save">确定</button>
            </div>
        </div><!-- /.modal-content -->
        </form>
    </div><!-- /.modal -->
</div>
{% endblock %}
{% endblock %}

{% block script %}
<script type="text/javascript">
    toastr.options.positionClass = 'toast-center-center';    //如toast-bottom-right表示下右、toast-bottom-center表示下中、toast-top-center表示上中等

function currentTime(){
    var datetime = new Date();
    //datetime.setTime(time);
    var year = datetime.getFullYear();
    var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
    var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
    var hour = datetime.getHours()< 10 ? "0" + datetime.getHours() : datetime.getHours();
    var minute = datetime.getMinutes()< 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
    var second = datetime.getSeconds()< 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
    return year + "-" + month + "-" + date+" "+hour+":"+minute+":"+second;
}
</script>
<script>
$(function(){
    $('.modal').draggable();   //实现模态框拖移
    $("#query_list").val("")  //保存查询条件字符串
    //所有下拉控件的初始化
    $('.selectpicker').selectpicker({
        liveSearch:true,
        container: "body",
        liveSearch: true,
        width: 200,
        size: 5
    });
    //模态框 日期控件的初始化
    var date_list = ['repair_date','repair_confirm_date','equipment_return_date','repair_return_date'];
    $.each(date_list, function(i, item){
        $("#" + item).datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            weekStart: 0,
            //startDate:new Date(),
            autoclose: true,
            startView: 2,  	//打开时显示的视图。0-'hour' 1-'day' 2-'month' 3-'year' 4-'decade'
            todayBtn : true,
            todayHighlight: true,
            bootcssVer:3,	//显示向左向右的箭头
            forceParse: true,  	//当输入非格式化日期时，强制格式化。默认true
            initialDate: new Date(),	//初始化日期.默认new Date()当前日期
            showMeridian: true, //是否显示上下午
            keyboardNavigation: true, //方向键改变日期
            language: 'zh-CN' //语言
        })
    });

    var select_list = [
        {"id":"query_dept_code", "url":"/repair/api/v1.0/departments", "valuefield":"code", "textfield":"name"},
        {"id":"query_brand_code", "url":"/repair/api/v1.0/equipment_brands", "valuefield":"code", "textfield":"name"},
        {"id":"query_type_code", "url":"/repair/api/v1.0/equipment_types", "valuefield":"code", "textfield":"name"},
        {"id":"query_fault_code", "url":"/repair/api/v1.0/equipment_faults", "valuefield":"code", "textfield":"name"},
        {"id":"query_com_code", "url":"/repair/api/v1.0/repair_companys", "valuefield":"code", "textfield":"name"}
    ];

    function init(target, data, valuefield, textfield) {
                var option = $('<option></option>');
                target.append(option);
               $.each(data, function (i, item) {
                   var option = $('<option></option>');
                   option.attr('value', item[valuefield]);
                   option.text(item[textfield]);
                   target.append(option);
               });
        target.selectpicker('refresh');
        target.selectpicker('render');
    };
    //$(id_list).each(function(){ 使用此方式就是获取不到ID的值？？？？
    $.each(select_list, function (i, item) {
        $.get(item.url,function(data,status){
            init($("#"+item['id']), data.rows, item['valuefield'],item['textfield']);
          });
    });

    var id_list = [
        {"start":"query_repair_date", "end":"query_repair_date_end"},
        {"start":"query_equipment_confirm_date", "end":"query_equipment_confirm_date_end"},
        {"start":"query_repair_return_date", "end":"query_repair_return_date_end"},
        {"start":"query_equipment_return_date", "end":"query_equipment_return_date_end"}
    ];

    $.each(id_list, function(i, item){
        $("#" + item.start).datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            weekStart: 0,
            //startDate:new Date(),
            autoclose: true,
            startView: 2,  	//打开时显示的视图。0-'hour' 1-'day' 2-'month' 3-'year' 4-'decade'
            todayBtn : true,
            todayHighlight: true,
            bootcssVer:3,	//显示向左向右的箭头
            forceParse: true,  	//当输入非格式化日期时，强制格式化。默认true
            initialDate: new Date(),	//初始化日期.默认new Date()当前日期
            showMeridian: true, //是否显示上下午
            keyboardNavigation: true, //方向键改变日期
            showFooter: true,
            language: 'zh-CN' //语言
        }).on("click",function(){
        $("#" + item.start).datetimepicker("setEndDate",$("#" + item.end).val())});

        $("#" + item.end).datetimepicker({
            format: 'yyyy-mm-dd hh:ii',
            weekStart: 0,
            //startDate:new Date(),
            autoclose: true,
            startView: 2,  	//打开时显示的视图。0-'hour' 1-'day' 2-'month' 3-'year' 4-'decade'
            todayBtn : true,
            todayHighlight: true,
            bootcssVer:3,	//显示向左向右的箭头
            forceParse: true,  	//当输入非格式化日期时，强制格式化。默认true
            initialDate: new Date(),	//初始化日期.默认new Date()当前日期
            showMeridian: true, //是否显示上下午
            keyboardNavigation: true, //方向键改变日期
            language: 'zh-CN' //语言
        }).on("click",function(){
        $("#" + item.end).datetimepicker("setStartDate",$("#" + item.start).val())});
    });
    //查询按钮绑定事件
    $("#query_search").click(function(){
        var temp = {};
        $('input:checkbox:checked').each(function(i,val){
            input_id = val.id.substr(3);  //'cb_query_repair_date'

            //处理开始和结束日期，放入数组
            list = new Array();
            if(input_id.indexOf("_date") >= 0 ) {
                list.push($("#"+input_id).val());
                list.push($("#"+input_id+"_end").val());
                value = list;
            }
            else{
                value = $("#"+input_id).val();
            }
            temp[input_id.substr(6)] = value;   //'query_repair_date' 与数据库字段一致
            //alert("你选了："+$('input[type=checkbox]:checked').length+"个，其中有："+input_id+":"+value);
        });
        $("#query_list").val(JSON.stringify(temp)); //赋值给隐藏控件
        //initTable(JSON.stringify(temp),'json');
        $("#table_repairs").bootstrapTable("refresh");
    });
    //重置按钮绑定事件  导致表格内容列的勾选框也去掉, 限定id=pn_query的div内重置
    $("#query_reset").click(function(){
        //取消全选
        $("#pn_query input[type='checkbox']").removeAttr("checked");
        //清除文本框的值,包含隐藏input
        $("#pn_query input").val("");
        //清除选择框的值
        $('#pn_query .selectpicker').selectpicker("val","");
    });
});
</script>
<!-- 数据表格初始化 -->
<script>
var action = '';  //保存操作状态
var cur_key = '';  //当前选中的主键值
var flag = 0;  //执行操作、提交是否成功
//表格初始化
//initTable();

//表格初始化
function initTable(querystr, querytype) {
    // 删除表格定义   如缺少会导致显示内容列下拉选择无效
    $("#table_repairs").bootstrapTable('destroy');
    $("#table_repairs").bootstrapTable({
        //表格高度
        //height: getHeight()-300,
        //服务器数据的请求方式 'get' 或 'post'。
        method: 'get',
        //设置为 true 会有隔行变色效果
        striped: true,
        //设置为 true 会在表格底部显示分页条。
        pagination: true,
        //请求后台的URL
        url: '/repair/api/v1.0/equipment_repairs',
        //服务器返回的数据类型。
        dataType: 'json',
        //工具按钮用哪个容器
        toolbar: '#toolbar',
        //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性
        cache: false,
        //设置为 true 启用分页条无限循环的功能
        paginationLoop: false,
        //设置在哪里进行分页，可选值为 'client' 或者 'server'。设置 'server'时，必须设置服务器数据地址（url）或者重写ajax方法
        sidePagination: 'client',
        //初始化加载第一页，默认第一页
        pageNumber: 1,
        //每页的记录行数
        pageSize: 10,
        //可供选择的每页的行数
        pageList: [5,10,15,20, 50, 100],
        //设置为false 将禁止所有列的排序。
        sortable: true,
        //设置默认排序为 name
        sortName: 'id',
        //定义排序方式，'asc' 或者 'desc'。
        sortOrder: "desc",
        //是否显示刷新按钮
        showRefresh: true,
        //是否显示内容列下拉框。
        showColumns: true,
        //显示导出插件
        showExport: true,
        exportDataType: "all",  //basic', 'all', 'selected'. 表示导出的模式是当前页、所有数据还是选中数据
        //是否显示右上角的搜索框
        search: true,
        //是否启用点击选中行
        clickToSelect: false,
        uniqueId: "id",                     //每一行的唯一标识，一般为主键列
        showToggle: false,                   //是否显示详细视图和列表视图的切换按钮
        cardView: false,                    //是否显示详细视图
        detailView: true,                  //是否显示父子表
        //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
        //设置为limit可以获取limit, offset, search, sort, order
        queryParamsType:'limit',
        searchOnEnterKey: false,
        rowStyle: function (row, index) {
                //这里有5个取值代表5中颜色['active', 'success', 'info', 'warning', 'danger'];
                var strclass = "";
                if (row.repair_priority == 1 && row.repair_status != 3) {
                    strclass = 'info';
                }
                else if (row.repair_priority == 2 && row.repair_status != 3) {
                    strclass = 'warning';
                }
                else if (row.repair_priority == 3 && row.repair_status != 3) {
                    strclass = 'danger';
                }
                else {
                    return {};
                }
                return { classes: strclass }
        },
        //请求服务器数据
        queryParams: function queryParams(params){
            if ($("#query_list").val()!= ''){
                querystr = $("#query_list").val();
                querytype = 'json'
            }
            var param = {
                limit: params.limit,
                offset: params.offset,
                search: params.search,
                querytype: querytype,
                querystr: querystr,
                sort: params.sort,
                order: params.order,
                sidePagination: 'client'
            };
            return param;
        },
        //加载成功时执行
        onLoadSuccess: function(data){
            console.log("加载成功");
        },
        //加载失败时执行
        onLoadError: function(status){
            console.log("加载数据失败"+status);
        },
        onDblClickRow: function (row, $element) {
            var id = row.id;
            return false;
        },
        onCheck: function(row,$element){
            cur_key = row.id;
        },
        columns: [
            {
                title: "全选",
                field: "select",
                checkbox: true,
                width: 20,//宽度
                //align: "center",//水平
                //valign: "middle",
                formatter: function (value, row, index) {
                return row._id;
            }
            },{
                field: 'id',
                title: '维修单号',
                align: 'left',
                valign: 'middle',
                sortable: true
                        },{
                field: 'repair_priority',
                title: '紧急程度',
                align: 'left',
                valign: 'middle',
                sortable: true,
                formatter: function (value, row, index) {
                    if (value == 0 ){
                        value = '一般'}
                    else if(value == 1){
                        value = '比较急'}
                    else if(value == 2){
                        value = '非常急'}
                    else if(value == 3){
                        value = '特急'}
                    return value
                }
            },{
                field: 'repair_status',
                title: '维修进度',
                align: 'left',
                valign: 'middle',
                sortable: true,
                formatter: function (value, row, index) {
                    if (value == 0 ){
                        value = '未确认'}
                    else if(value == 1){
                        value = '已确认'}
                    else if(value == 2){
                        value = '维修中'}
                    else if(value == 3){
                        value = '已完成'}
                    return value
                }
            },{
                field: 'repair_result',
                title: '维修结果',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_date',
                title: '报修日期',
                align: 'left',
                valign: 'middle',
                sortable: true
                //formatter: function (value, row, index) {
                  //  return changeDateFormat(value)
                //}
            },{
                field: 'repair_department',
                title: '报修科室',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_registrant',
                title: '报修人',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_brand',
                title: '设备品牌',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_type',
                title: '设备类型',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_code',
                title: '设备编号',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_fault',
                title: '设备故障',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_company',
                title: '维修公司',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_man',
                title: '维修人',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_confirm_date',
                title: '维修确认日期',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_return_date',
                title: '维修归还日期',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_return_man',
                title: '维修归还人',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_return_date',
                title: '归还科室日期',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'equipment_return_man',
                title: '归还科室人',
                align: 'left',
                valign: 'middle',
                sortable: true
            },{
                field: 'repair_remarks',
                title: '备注',
                align: 'left',
                valign: 'middle',
                sortable: true
            }
        ]
    });
};
//转换日期格式(时间戳转换为datetime格式)
function changeDateFormat(value) {
    if (value != null && value != undefined && value != '') {
        var date = new Date(value);
        return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes();
    }
};
</script>
<!-- 表单数据获取，提交 -->
<script>
    //将提交的表单数值序列化为JSON对象
    function get_json_data(){
        var d = {};
    var t = $('form').serializeArray();
    $.each(t, function() {
      d[this.name] = this.value;
    });
    //alert(JSON.stringify(d));
        return d;
    };
    //提交表单数据到服务器
    function ajax_post_data(url, data){
         $.ajax({
				type: "POST",
				dataType: "json",
				url: url,
				data: data,  //json对象，非json字符串
				timeout:30000,
				error: function(request) {
				    toastr.error('提交数据失败！');
					//alert("Connection error:"+request.error);
				},
				success: function(data) {
				    toastr.success('提交数据成功');
				}
		 })
    };
</script>
{% endblock %}
